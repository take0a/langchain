# Tool calling

:::info[Prerequisites]
* [Tools](/docs/concepts/tools)
* [Chat Models](/docs/concepts/chat_models)
:::


## 概要

多くのAIアプリケーションは人間と直接対話します。このような場合、モデルは自然言語で応答するのが適切です。
しかし、モデルがデータベースやAPIなどのシステムとも*直接*対話する必要がある場合はどうでしょうか？
これらのシステムは多くの場合、特定の入力スキーマを持っています。例えば、APIは多くの場合、必須のペイロード構造を持っています。
このニーズから、*ツール呼び出し*という概念が生まれました。[ツール呼び出し](https://platform.openai.com/docs/guides/function-calling/example-use-cases)を使用すると、特定のスキーマに一致するモデルの応答を要求できます。

:::info
「関数呼び出し」という言葉を耳にすることがあるでしょう。この用語は「ツール呼び出し」と同義で使われます。
:::

![Conceptual overview of tool calling](/img/tool_calling_concept.png)

## 主要な概念

1. **ツールの作成:** [@tool](https://python.langchain.com/api_reference/core/tools/langchain_core.tools.convert.tool.html) デコレータを使用して [ツール](/docs/concepts/tools) を作成します。ツールとは、関数とそのスキーマを関連付けたものです。<br/>
2. **ツールのバインディング:** ツールは、ツール呼び出しをサポートするモデルに接続する必要があります。これにより、モデルはツールと、ツールに必要な入力スキーマを認識できるようになります。<br/>
3. **ツールの呼び出し:** 適切な場合、モデルはツールを呼び出すことを決定し、その応答がツールの入力スキーマに準拠していることを確認できます。<br/>
4. **ツールの実行:** モデルによって提供された引数を使用してツールを実行できます。

![Conceptual parts of tool calling](/img/tool_calling_components.png)

## 推奨される使用方法

この擬似コードは、ツール呼び出しを使用する際の推奨ワークフローを示しています。
作成されたツールは、リストとして `.bind_tools()` メソッドに渡されます。
このモデルは通常どおり呼び出すことができます。ツール呼び出しが行われると、モデルのレスポンスにツール呼び出し引数が含まれます。
ツール呼び出し引数はツールに直接渡すことができます。

```python
# Tool creation
tools = [my_tool]
# Tool binding
model_with_tools = model.bind_tools(tools)
# Tool calling 
response = model_with_tools.invoke(user_input)
```

## ツールの作成

ツールを作成するには、`@tool` デコレータを使用することをお勧めします。

```python
from langchain_core.tools import tool

@tool
def multiply(a: int, b: int) -> int:
    """Multiply a and b."""
    return a * b
```

:::info[Further reading]

* 詳細については、[ツール](/docs/concepts/tools/)の概念ガイドをご覧ください。
* ツール呼び出しをサポートする[モデル統合](/docs/integrations/chat/)をご覧ください。
* ツール呼び出しに関する[ハウツーガイド](/docs/how_to/tool_calling/)をご覧ください。

:::

## ツールバインディング

[多くの](https://platform.openai.com/docs/guides/function-calling) [モデルプロバイダー](https://platform.openai.com/docs/guides/function-calling) がツール呼び出しをサポートしています。

:::tip
ツールの呼び出しをサポートするプロバイダーの一覧については、[モデル統合ページ](/docs/integrations/chat/)を参照してください。
:::

理解すべき中心的な概念は、LangChain がツールをモデルに接続するための標準化されたインターフェースを提供していることです。
`.bind_tools()` メソッドを使用すると、モデルが呼び出せるツールを指定できます。

```python
model_with_tools = model.bind_tools(tools_list)
```

具体的な例として、関数 `multiply` をツール呼び出しをサポートするモデルにツールとしてバインドしてみましょう。

```python
def multiply(a: int, b: int) -> int:
    """Multiply a and b.

    Args:
        a: first int
        b: second int
    """
    return a * b

llm_with_tools = tool_calling_model.bind_tools([multiply])
```

## ツール呼び出し

![Diagram of a tool call by a model](/img/tool_call_example.png)

ツール呼び出しの重要な原則は、モデルが入力の関連性に基づいてツールを使用するタイミングを決定することです。モデルは常にツールを呼び出す必要はありません。例えば、無関係な入力が与えられた場合、モデルはツールを呼び出しません。

```python
result = llm_with_tools.invoke("Hello world!")
```

結果は、モデルの自然言語による応答（例：「Hello!」）を含む `AIMessage` になります。
ただし、*ツールに関連する*入力を渡した場合、モデルはそれを呼び出すことを選択する必要があります。

```python
result = llm_with_tools.invoke("What is 2 multiplied by 3?")
```

これまでと同様に、出力 `result` は `AIMessage` になります。
ただし、ツールが呼び出された場合、`result` には `tool_calls` [属性](https://python.langchain.com/api_reference/core/messages/langchain_core.messages.ai.AIMessage.html#langchain_core.messages.ai.AIMessage.tool_calls) が含まれます。
この属性には、ツール名や入力引数など、ツールの実行に必要なすべての情報が含まれます。

```
result.tool_calls
[{'name': 'multiply', 'args': {'a': 2, 'b': 3}, 'id': 'xxx', 'type': 'tool_call'}]
```

使用方法の詳細については、[ハウツーガイド](/docs/how_to/#tools)をご覧ください。

## ツールの実行

[ツール](/docs/concepts/tools/)は[Runnable](/docs/concepts/runnables/)インターフェースを実装しているため、直接呼び出すことができます（例：`tool.invoke(args)`）。

[LangGraph](https://langchain-ai.github.io/langgraph/)は、多くの場合、ユーザーに代わってツールを呼び出す、ビルド済みのコンポーネント（例：[`ToolNode`](https://langchain-ai.github.io/langgraph/reference/prebuilt/#langgraph.prebuilt.tool_node.ToolNode)）を提供します。

:::info[Further reading]

* ツール呼び出しについては、[ハウツーガイド](/docs/how_to/tool_calling/)をご覧ください。
* ToolNode の使用については、[LangGraph ドキュメント](https://langchain-ai.github.io/langgraph/how-tos/tool-calling/)をご覧ください。

:::

## ツールの使用を強制する

デフォルトでは、モデルはユーザーの入力に基づいて使用するツールを自由に選択できます。しかし、特定のシナリオでは、モデルの意思決定プロセスに影響を与えたい場合があります。LangChainでは、ツールの選択を強制（`tool_choice` を使用）することで、モデルが特定のツール、または指定されたリスト内の任意のツールのいずれかを使用することを保証できます。これは、モデルの挙動を構造化し、望ましい結果に導くのに役立ちます。

:::info[Further reading]

* ツールの使用を強制する方法については、[ハウツーガイド](/docs/how_to/tool_choice)をご覧ください。

:::

## ベストプラクティス

モデルで使用する[ツール](/docs/concepts/tools/)を設計する際には、以下の点に留意することが重要です。

* 明示的な[ツール呼び出しAPI](/docs/concepts/tool_calling)を持つモデルは、微調整されていないモデルよりもツール呼び出しが優れています。
* ツールの名前と説明が適切に選択されていると、モデルのパフォーマンスが向上します。
* シンプルでスコープが狭いツールは、複雑なツールよりもモデルにとって使いやすいです。
* モデルに多数のツールリストから選択させると、モデルにとって課題が生じます。


